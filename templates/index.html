<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finbot</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <img src="https://cdn-icons-png.flaticon.com/512/2593/2593627.png" alt="Finbot Icon" class="icon">
                Finbot
            </h1>
            <p class="description">AI-powered chatbot designed to analyse corporate financial performance from 10-K and 10-Q documents.</p>
        </div>
        <div class="chatbox" id="chatbox">
            <div class="message message-bot">
                <div class="message-content">
                    Welcome to Finbot! Upload a PDF to start.
                </div>
            </div>
        </div>
        <div class="upload-section">
            <form id="uploadForm" enctype="multipart/form-data">
                <label for="fileInput" class="custom-file-upload">
                    <input type="file" name="file" id="fileInput">
                    Select PDF File
                </label>
                <button type="submit" class="btn">Upload</button>
                <div id="progressWrapper">
                    <progress id="progressBar" value="0" max="100"></progress>
                    <span id="processingText">Processing...</span>
                </div>
            </form>
        </div>
        <div class="input-section">
            <input type="text" id="queryInput" placeholder="Ask a question..." class="query-input">
            <button id="queryButton" class="btn">Send</button>
        </div>
        <div class="reset-section">
            <button id="resetButton" class="btn">Restart Chat</button>
        </div>
        <div class="links">
            Sample 10-K Report for Microsoft:
            <a href="https://www.sec.gov/Archives/edgar/data/789019/000095017024087843/msft-20240630.htm" target="_blank">Microsoft 10-K Report 2024</a>
            <br>Search for other 10-K and 10-Q documents:
            <a href="https://www.sec.gov/search-filings" target="_blank">SEC Search Filings</a>
            <br>View this project on GitHub:
            <a href="https://github.com/deepakb41/Finbot" target="_blank">GitHub Repository</a>
        </div>
    </div>

    <script>
        function appendMessage(sender, message) {
            var chatbox = document.getElementById('chatbox');
            var messageDiv = document.createElement('div');
            messageDiv.classList.add('message', `message-${sender}`);
            var messageContent = document.createElement('div');
            messageContent.classList.add('message-content');
            messageContent.innerText = message;
            messageDiv.appendChild(messageContent);
            chatbox.appendChild(messageDiv);
            chatbox.scrollTop = chatbox.scrollHeight;
        }

        document.getElementById('uploadForm').addEventListener('submit', function(event) {
            event.preventDefault();
            var formData = new FormData();
            var fileInput = document.getElementById('fileInput');
            formData.append('file', fileInput.files[0]);

            document.getElementById('progressWrapper').style.display = 'inline-flex';
            appendMessage('bot', 'Uploading and processing the PDF...');

            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/upload', true);

            // Track the upload progress
            xhr.upload.onprogress = function(event) {
                if (event.lengthComputable) {
                    var percentComplete = (event.loaded / event.total) * 70; // Allocate 70% of the progress to upload
                    document.getElementById('progressBar').value = percentComplete;
                }
            };

            xhr.onload = function() {
                if (xhr.status === 200) {
                    var data = JSON.parse(xhr.responseText);
                    if (data.status === 'success') {
                        // Simulate processing phase by gradually filling the remaining 30% of the progress bar
                        let processingProgress = 70;
                        let processingInterval = setInterval(function() {
                            processingProgress += 2; // Increase progress by 2% every 100ms
                            document.getElementById('progressBar').value = processingProgress;
                            if (processingProgress >= 100) {
                                clearInterval(processingInterval);
                                appendMessage('bot', data.message);
                                document.getElementById('progressWrapper').style.display = 'none';
                            }
                        }, 100);
                    } else {
                        appendMessage('bot', 'Failed to upload file. Please try again.');
                        document.getElementById('progressWrapper').style.display = 'none';
                    }
                } else {
                    appendMessage('bot', 'Error occurred: ' + xhr.statusText);
                    document.getElementById('progressWrapper').style.display = 'none';
                }
            };

            xhr.send(formData);
        });

        document.getElementById('queryButton').addEventListener('click', function() {
            var queryInput = document.getElementById('queryInput');
            var query = queryInput.value;
            queryInput.value = '';

            appendMessage('user', query);

            fetch('/query', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ query: query })
            }).then(response => response.json())
              .then(data => {
                  appendMessage('bot', data.response);
              }).catch(error => {
                  appendMessage('bot', 'Error occurred: ' + error.message);
              });
        });

        document.getElementById('resetButton').addEventListener('click', function() {
            fetch('/reset', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            }).then(response => response.json())
              .then(data => {
                  if (data.status === 'success') {
                      document.getElementById('chatbox').innerHTML = ''; // Clear the chatbox
                      appendMessage('bot', 'Welcome to Finbot! Upload a PDF to start.'); // Display welcome message again
                  } else {
                      appendMessage('bot', 'Failed to reset. Please try again.');
                  }
              }).catch(error => {
                  appendMessage('bot', 'Error occurred: ' + error.message);
              });
        });
    </script>
</body>
</html>
